<!DOCTYPE html>
<!--
  Copyright 2011 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Chrome DevRel Team (chrome-devrel@googlegroups.com)
                 Alex Russell (slightlyoff@chromium.org)
                 Brad Neuberg
-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" />
    <title>Tooling Around with Abstract Syntax Trees</title>
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans|Droid+Sans+Mono"
	  rel="stylesheet" type="text/css" />
    <link id="prettify-link" href="src/prettify/prettify.css"
	  rel="stylesheet" disabled />
    <link href="css/moon.css" class="theme" rel="stylesheet" />
    <link href="css/sand.css" class="theme" rel="stylesheet" />
    <link href="css/sea_wave.css" class="theme" rel="stylesheet" />
    <link href="css/default.css" class="theme" rel="stylesheet" media="screen"  />
    <link href="css/common.css" rel="stylesheet" media="screen" />
  </head>
  <body>
    <nav id="helpers">
      <button title="Previous slide" id="nav-prev" class="nav-prev">⇽</button>
      <button title="Jump to a random slide" id="slide-no">5</button>
      <button title="Next slide" id="nav-next" class="nav-next">⇾</button>
      <menu>
        <button type="checkbox" data-command="toc" title="Table of Contents" class="toc">TOC</button>
        <button type="checkbox" data-command="notes" title="View Slide Notes">✏</button>
        <button type="checkbox" data-command="source" title="View slide source">↻</button>
        <button type="checkbox" data-command="help" title="View Help">?</button>
      </menu>
    </nav>

    <div class="presentation">
      <div id="presentation-counter">Loading...</div>
      <div class="slides">

<div class="slide" id="landing-slide">
  <style>
    #landing-slide p {
    font-size: 35px;
    }
    p#disclaimer-message {
    font-size: 20px;
    }
  </style>
  <section class="middle">
    <p>This presentation is an HTML5 website</p>
    <p>Press <span id="left-init-key" class="key">&rarr;</span> key to advance.</p>
    <p id="disclaimer-message">Having issues seeing the presentation? Read the <a href="http://slides.html5rocks.com/disclaimer.html">disclaimer</a></p>
  </section>
</div>

<div class="slide" id="controls-slide">
  <header>Slides controls</header>
  <style>
    #controls-slide li, #controls-slide p {
    font-size: 32px;
    }
    #controls-slide .key {
    bottom: 2px;
    }
    .slide h1 {font-size: 50px; }
  </style>
  <section>
    <ul>
      <li><span class="key">&larr;</span> and <span class="key">&rarr;</span> to move around.</li>
      <li><span class="key">Ctrl/Command</span> and <span class="key">+</span> or <span class="key">-</span> to zoom in and out if slides don’t fit.</li>
      <li><span class="key">S</span> to view page source.</li>
      <li><span class="key">T</span> to change the theme.</li>
      <li><span class="key">H</span> to toggle syntax highlight.</li>
      <li><span class="key">N</span> to toggle speaker notes.</li>
      <li><span class="key">3</span> to toggle 3D effect.</li>
      <li><span class="key">0</span> to toggle help.</li>
    </ul>
  </section>
  <aside class="note">
    <section>
      Wel
    </section>
  </aside>
</div>

<div class="slide" id="title-slide">
  <style>
    #title-slide h1, #title-slide h2 {
    color: black;
    }
    #title-slide h1 {
    letter-spacing: -2px;
    font-size: 60px;
    }
    #title-slide h2 {
    margin-top: -5px;
    font-size: 30px;
    letter-spacing: -1px;
    }
  </style>
  <section class="middle">
    <hgroup>
      <h1>Tooling Around with Abstract Syntax Trees</h1>
      <h2>Philly PUG Meetup, August 2011</h2>
    </hgroup>
    <p>Greg Guthe, Aweber Communications</p>
  </section>
</div>

<div class="slide" id="problem-slide">
  <style>
    #problem-slide section > h1 {
    font-size: 40px;
    text-align: center;
    vertical-align: center;
    margin-right: 5px;
    }
    #problem-slide section pre {
    font-size: 30px;
    }
  </style>
  <section>
    <header><h1>What calls what using the Queue?</h1></header>

    <img src="pictures/problem.dot.svg" width="100%" height="70%">
  </section>
</div>

<div class="slide" id="python-compilation-slide">
  <section>
    <header><h1>Python Compilation</h1></header>
    <a href="http://nedbatchelder.com/text/aware.html" target="_blank">Ned Batchelder, Python-Aware Python, Pycon 2011</a>
    <img src="pictures/code-stages.svg" width="100%" height="100%" alt="">
  </section>
</div>

<div class="slide" id="ast-packages">
  <style>
    #ast-packages p,li {
    font-size: 30px;
    }
    #ast-packages ul ul li {
    font-size: 25px;
    margin: 0;
    padding: 2px;
    }
  </style>
  <section>
    <header><h1>AST Packages</h1></header>
    <p>From the standard library:
    <ul>
      <li>_ast - Node classes (Python 2.5+)
      <li><a href="http://docs.python.org/library/ast.html">ast</a> - helper functions (Python 2.6+)
    </ul>
    <p>Third Party:
    <ul>
      <li><a href="https://github.com/mitsuhiko/pyastutil">pyastutil</a> and <a href="http://dev.pocoo.org/hg/sandbox/file/b2aea937f5bb/ast/codegen.py">codegen.py</a> - ast to source</a>
      <li><a>logilab-astng</a>
	<ul>
	  <li>pylint and pyreverse dependency
   	  <li>Uses live objects and "New Generation" AST
	  <li>Nice expanded print_tree
      	  <li>Tracks scope with breadth first visitors
	  <li>All the docs I could find: <a href="http://www.logilab.org/card/eid/21900">A Short Introduction</a>
	</ul>
    </ul>
  </section>
</div>

<div class="slide" id="whats-an-ast-slide">
  <style>
    section > h1 {
    font-size: 40px;
    text-align: center;
    vertical-align: center;
    margin-right: 5px;
    }
    #whats-an-ast-slide section pre {
    font-size: 30px;
    }
  </style>
  <section>
    <header><h1>What's an abstract syntax tree (AST)?</h1></header>
    <h1>A tree representing the abstract syntactic structure of source code.</h1><a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">Wikipedia</a>
<pre>
>>> import ast
>>> code = "print 'hello world'"
>>> ast.parse(code)
<_ast.Module object at 0x100493990>
>>> ast.dump(ast.parse(code))
"Module(body=[Print(dest=None,
values=[Str(s='hello world')], nl=True)])"
>>>
</pre>
  </section>
</div>

<div class="slide" id="whats-a-tree">
  <section>
    <ul data-build>
      <li><h1>OK, an AST is some sort of tree.</h1>
      <li><h1>What's a tree?</h1>
      <li><h1>A tree is a directed, acyclic, rooted graph where all edges point away from the root.</h1>
      <li><h1>Huh?</h1>
    </ul>
  </section>
</div>

<div class="slide" id="whats-a-graph">
  <section>
    <header><h1>What's a graph?</h1></header>
    <h1>Nodes joined by edges</h1>
    <img src="pictures/triangle.dot.svg" width="70%" height="70%">
  </section>
</div>

<div class="slide" id="whats-a-directed-graph">
  <style>
    section > h1 {
    font-size: 30px;
    text-align: center;
    vertical-align: center;
    margin-right: 5px;
    }
  </style>
  <section>
    <header><h1>What's a directed graph?</h1></header>
    <h1>Edges have a direction</h1>(hopscotch, board games)
    <img src="pictures/directed.dot.svg" width="100%" height="70%">
  </section>
</div>

<div class="slide" id="whats-an-acyclic-graph">
  <section>
    <header><h1>What's an acyclic graph?</h1></header>
    <h1>No cycles or loops</h1>
    <img src="pictures/cycles.dot.svg" width="100%" height="100%" >
  </section>
</div>

<div class="slide" id="whats-a-rooted-graph">
  <section>
    <header><h1>What's a rooted graph?</h1></header>
    <h1>Has a special root node</h1>
    <img src="pictures/noroot.dot.svg" width="45%" height="50%" >
    <img src="pictures/root.dot.svg" width="45%" height="50%" style="float:right" >
    <h2>One of these is a rooted graph</h2>
  </section>
</div>

<div class="slide" id="whats-a-tree-again">
  <section>
    <header><h1>What's a tree again?</h1></header>
    <h1>A tree is a directed, acyclic, rooted graph where all edges point away from the root.</h1>(boring game of shoots and ladders)
    <img src="pictures/tree.dot.svg" width="100%" height="50%" >
  </section>
</div>

<div class="slide" id="summarize-file">
  <style>
    #summarize-file pre {
    font-size: 18px;
    }
  </style>
  <section>
    <header><h1>What's in the ast module?</h1></header>
<pre>
import ast
import inspect

ast_ast = ast.parse(inspect.getsource(ast))

for node in ast.iter_child_nodes(ast_ast):
    if isinstance(node, ast.FunctionDef) or isinstance(node, ast.ClassDef):
        print node.name
    else:
        print node

<_ast.Expr object at 0x10064b3d0>
<_ast.ImportFrom object at 0x10064b450>
<_ast.ImportFrom object at 0x10064b4d0>
parse
literal_eval
dump
copy_location
fix_missing_locations
increment_lineno
iter_fields
iter_child_nodes
get_docstring
walk
NodeVisitor
NodeTransformer
</pre>
  </section>
</div>

<div class="slide" id="nodevisitor-slide">
  <style>
    #nodevisitor-slide pre {
    font-size: 28px;
    }
  </style>
  <section>
    <header><h1>How do I visit all the nodes?</h1></header>
<pre>
import ast

class AllVisitor(ast.NodeVisitor):

    def visit_Module(self, node):
        print node

AllVisitor().visit(ast.parse("def foo(): pass"))

<_ast.Module object at 0x1004aa150>
</pre>
  </section>
</div>

<div class="slide" id="nodevisitor-kids">
  <style>
    #nodevisitor-kids pre {
    font-size: 24px;
    }
  </style>
  <section>
    <header><h1>How do I visit all the nodes?</h1></header>
<pre>
class PrintVisitor(ast.NodeVisitor):

    def visit_Module(self, node):
        print 'Modular Monkeys'

        # See the kids
        self.generic_visit(node)

    def generic_visit(self, node):
        print node
        ast.NodeVisitor.generic_visit(self, node)

PrintVisitor().visit(ast.parse("def foo(): print 'bar';"))

Modular Monkeys
<_ast.Module object at 0x1004aa210>
<_ast.FunctionDef object at 0x1004aa250>
<_ast.arguments object at 0x1004aa290>
<_ast.Print object at 0x1004aa2d0>
<_ast.Str object at 0x1004aa310>
</pre>
  </section>
</div>

<div class="slide" id="printvisitor">
  <style>
    #printvisitor pre {
    font-size: 24px;
    }
  </style>
  <section>
    <header><h1>Where are the print statements?</h1></header>

<pre>
import ast

class PrintVisitor(ast.NodeVisitor):

    def visit_Print(self, node):
        print "line:", node.lineno,
        print "column:", node.col_offset
        print node, "value:", node.values[0].s

        # See the kids
        self.generic_visit(node)

PrintVisitor().visit(ast.parse("def foo(): print 'bar'"))

line: 1 column: 11
<_ast.Print object at 0x1004ab210> value: bar
</pre>
  </section>
</div>

<div class="slide" id="renamer">
  <style>
    #renamer pre {
    font-size: 24px;
    }
  </style>
  <section>
    <header><h1>Renaming Variables</h1></header>
<pre>
import ast
import astutil.codegen

class NamePrivatizer(ast.NodeTransformer):

    def visit_Name(self, node):
        return ast.copy_location(
            ast.Name(id='_' + node.id), node
        )
        # Visit my kids too
        self.generic_visit(node)

public_ast = ast.parse("print 'hi'; dog = foo;")
private_ast = NamePrivatizer().visit(public_ast)

print repr(astutil.codegen.to_source(private_ast))

"print 'hi'\n_dog = _foo"
</pre>
  </section>
</div>

<div class="slide" id="restack">
  <style>
    #restack pre {
    font-size: 18px;
    }
  </style>
  <section>
    <header><h1>Back Up The Tree: Parents?</h1></header>
<pre>
class StackVisitor(ast.NodeVisitor):
...
    def restack(self, node):
        if not isinstance(node, ast.Module):
            stack = self.stack

            while True:
                parent = stack.pop()

                if node in ast.iter_child_nodes(parent):
                    stack.append(parent)
                    stack.append(node)
                    break

            self.stack = node.stack = stack
        else:
            assert not hasattr(self, 'stack')
            # A Module node must be the AST root and stack base
            self.stack = [node]

        # Keep a copy of the stack because self.stack changes
        node.stack = copy.copy(self.stack)

    def generic_visit(self, node):
        self.restack(node)
        ast.NodeVisitor.generic_visit(self, node)
</pre>
  </section>
</div>

<div class="slide" id="eventgraph">
  <section>
    <header><h1>Where is the Event Graph?</h1></header>
  </section>
</div>

<div class="slide" id="questions">
  <section>
    <header><h1>Questions?</h1></header>
    <p class="center"><img src="pictures/turtle.png" width="349px" height="204px"><a href="http://learnyouahaskell.com/faq">Turtle Credit</a>
    <h2 class="center"><a href="http://g-k.github.com/talks/2011-08-16-asts/">Slides: g-k.github.com/talks/2011-08-16-asts</a></h2>

  </section>
</div>

</div><!-- slides -->

      <div id="speaker-note" class="invisible" style="display: none;"></div>
      <aside id="help" class="sidebar invisible" style="display: hidden;">
  <table>
    <caption>Help</caption>
    <tbody>
      <tr>
        <th>Move Around</th>
        <td>&larr;&nbsp;&rarr;</td>
      </tr>
      <tr>
        <th>Source File</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Change Theme</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Syntax Highlight</th>
        <td>h</td>
      </tr>
      <tr>
        <th>Speaker Notes</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle 3D</th>
        <td>3</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>0</td>
      </tr>
    </tbody>
  </table>
</aside>
    </div> <!-- presentation -->

    <script src="src/prettify/prettify.js" onload="prettyPrint();" defer></script>
    <script src="js/utils.js"></script>
  </body>
</html>
